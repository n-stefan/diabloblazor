class Graphics{constructor(){this.initGraphics=n=>{const t=document.getElementById("canvas");this.context=n?t.getContext("bitmaprenderer"):t.getContext("2d",{alpha:!1})};this.onRender=n=>{if(this.context instanceof ImageBitmapRenderingContext)this.context.transferFromImageBitmap(n.bitmap);else if(this.context instanceof CanvasRenderingContext2D){const t=this.context;for(let i of n.images){const n=t.createImageData(i.width,i.height),r=windowAny.Module.HEAPU8.subarray(i.data,i.data+i.width*i.height*4);n.data.set(r);t.putImageData(n,i.x,i.y)}if(n.text.length){if(t.save(),t.font="bold 13px Times New Roman",n.clip){const i=n.clip;t.beginPath();t.rect(i.x0,i.y0,i.x1-i.x0,i.y1-i.y0);t.clip()}for(let i of n.text){const n=i.color>>16&255,r=i.color>>8&255,u=i.color&255;t.fillStyle=`rgb(${n}, ${r}, ${u})`;t.fillText(i.text,i.x,i.y)}t.restore()}}}}}class Sound{constructor(){this.initSound=()=>{const n=window.AudioContext||windowAny.webkitAudioContext;if(n){this.context=null;try{this.context=new n}catch(t){}this.sounds=new Map}};this.createSound=(n,t)=>{if(this.context){const i=this.decodeAudioData(this.context,t.buffer);this.sounds.set(n,{buffer:i,gain:this.context.createGain(),panner:StereoPannerNode&&new StereoPannerNode(this.context,{pan:0})})}};this.createSoundRaw=(n,t,i,r,u)=>{if(this.context){const f=this.context.createBuffer(r,i,u);for(let n=0;n<r;++n)f.getChannelData(n).set(t.subarray(n*i,n*i+i));this.sounds.set(n,{buffer:Promise.resolve(f),gain:this.context.createGain(),panner:StereoPannerNode&&new StereoPannerNode(this.context,{pan:0})})}};this.duplicateSound=(n,t)=>{if(this.context){const i=this.sounds.get(t);i&&this.sounds.set(n,{buffer:i.buffer,gain:this.context.createGain(),panner:StereoPannerNode&&new StereoPannerNode(this.context,{pan:0})})}};this.playSound=(n,t,i,r)=>{const u=this.sounds.get(n);if(u){u.source&&u.source.then(n=>n.stop());u.gain.gain.value=Math.pow(2,t/1e3);const n=Math.pow(2,i/1e3);u.panner&&(u.panner.pan.value=1-2/(1+n));u.source=u.buffer.then(n=>{const t=this.context.createBufferSource();t.buffer=n;t.loop=!!r;let i=t.connect(u.gain);return u.panner&&(i=i.connect(u.panner)),i.connect(this.context.destination),t.start(),t})}};this.stopSound=n=>{const t=this.sounds.get(n);t&&t.source&&(t.source.then(n=>n.stop()),delete t.source)};this.deleteSound=n=>{const t=this.sounds.get(n);t&&t.source&&t.source.then(n=>n.stop());this.sounds.delete(n)};this.setVolume=(n,t)=>{const i=this.sounds.get(n);i&&(i.gain.gain.value=Math.pow(2,t/1e3))};this.decodeAudioData=(n,t)=>new Promise((i,r)=>{n.decodeAudioData(t,i,r)});windowAny.DApi.create_sound=this.createSound;windowAny.DApi.create_sound_raw=this.createSoundRaw;windowAny.DApi.play_sound=this.playSound;windowAny.DApi.stop_sound=this.stopSound;windowAny.DApi.delete_sound=this.deleteSound;windowAny.DApi.duplicate_sound=this.duplicateSound;windowAny.DApi.set_volume=this.setVolume}}class Progress{constructor(n,t,i){this.message=n;this.bytesLoaded=t;this.total=i}}class FileStore{constructor(){this.initIndexedDb=async()=>{this.store=new IdbKvStore("diablo_fs");for(let[n,t]of Object.entries(await this.store.json()))getInterop().dotNetReference.invokeMethod("SetFile",n.toLowerCase(),t)};this.readIndexedDb=async n=>await this.store.get(n.toLowerCase());this.indexedDbHasFile=async n=>{const t=await this.store.get(n.toLowerCase());return t?!0:!1};this.storeIndexedDb=async(n,t,i)=>{const r=windowAny.Module.HEAPU8.indexOf(0,n),u=String.fromCharCode.apply(null,windowAny.Module.HEAPU8.subarray(n,r)),f=windowAny.Module.HEAPU8.subarray(t,t+i),e=new Uint8Array(f);await this.store.set(u,e)};this.removeIndexedDb=async n=>{await this.store.remove(n)};this.readFile=n=>new Promise((t,i)=>{const r=new FileReader;r.onload=()=>t(r.result);r.onerror=()=>i(r.error);r.onabort=()=>i();r.onprogress=n=>getInterop().dotNetReference.invokeMethod("OnProgress",new Progress("Loading...",n.loaded,n.total));r.readAsArrayBuffer(n)});this.onDropFile=n=>{this.dropFile=this.getDropFile(n),this.dropFile&&(n.preventDefault(),getInterop().dotNetReference.invokeMethodAsync("Start",this.dropFile.name.toLowerCase(),!0))};this.getDropFile=n=>{const t=n.dataTransfer.items;if(t)for(let n=0;n<t.length;++n)if(t[n].kind==="file")return t[n].getAsFile();const i=n.dataTransfer.files;if(i.length)return i[0]};this.setDropFile=async()=>{const n=new Uint8Array(await this.readFile(this.dropFile));getInterop().dotNetReference.invokeMethod("SetFile",this.dropFile.name.toLowerCase(),n);this.dropFile=null};this.getRenderInterval=()=>{const n=localStorage.getItem("DiabloRenderInterval");return n?parseInt(n):50};this.setRenderInterval=n=>{localStorage.setItem("DiabloRenderInterval",n.toString())}}}class Interop{constructor(){this.setDotNetReference=n=>{this._dotNetReference=n};this.addEventListeners=()=>{window.addEventListener("resize",()=>this._dotNetReference.invokeMethodAsync("OnResize",this.getCanvasRect()));const n=document.getElementById("main");n.addEventListener("drop",n=>this._fileStore.onDropFile(n))};this.getCanvasRect=()=>this.canvas.getBoundingClientRect();this.reload=()=>{window.location.reload()};this.clickDownloadLink=(n,t,i)=>{n.setAttribute("download",t),n.setAttribute("href",i),n.click(),n.removeAttribute("download"),n.removeAttribute("href")};this._graphics=new Graphics;this._sound=new Sound;this._fileStore=new FileStore}get graphics(){return this._graphics}get sound(){return this._sound}get fileStore(){return this._fileStore}get canvas(){return this._canvas||(this._canvas=document.getElementById("canvas")),this._canvas}get dotNetReference(){return this._dotNetReference}}const windowAny=window;windowAny.DApi={};windowAny.interop=new Interop;const getInterop=()=>windowAny.interop;