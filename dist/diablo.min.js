class Graphics{constructor(){this.initGraphics=n=>{const t=document.getElementById("canvas");this.context=n?t.getContext("bitmaprenderer"):t.getContext("2d",{alpha:!1})};this.drawBegin=()=>{this.renderBatch={images:[],text:[],clip:null}};this.drawEnd=()=>{this.onRender(),this.renderBatch=null};this.drawBlit=(n,t,i,r,u)=>{this.renderBatch.images.push({x:n,y:t,width:i,height:r,data:u.slice()})};this.drawClipText=(n,t,i,r)=>{this.renderBatch.clip={x0:n,y0:t,x1:i,y1:r}};this.drawText=(n,t,i,r)=>{this.renderBatch.text.push({x:n,y:t,text:i,color:r})};this.drawBelt=()=>{};this.onRender=()=>{if(this.context instanceof ImageBitmapRenderingContext)this.context.transferFromImageBitmap(this.renderBatch.bitmap);else if(this.context instanceof CanvasRenderingContext2D){const n=this.context;for(let t of this.renderBatch.images){const i=n.createImageData(t.width,t.height);i.data.set(t.data);n.putImageData(i,t.x,t.y)}if(this.renderBatch.text.length){if(n.save(),n.font="bold 13px Times New Roman",this.renderBatch.clip){const t=this.renderBatch.clip;n.beginPath();n.rect(t.x0,t.y0,t.x1-t.x0,t.y1-t.y0);n.clip()}for(let t of this.renderBatch.text){const i=t.color>>16&255,r=t.color>>8&255,u=t.color&255;n.fillStyle=`rgb(${i}, ${r}, ${u})`;n.fillText(t.text,t.x,t.y)}n.restore()}}};windowAny.DApi.draw_begin=this.drawBegin;windowAny.DApi.draw_end=this.drawEnd;windowAny.DApi.draw_blit=this.drawBlit;windowAny.DApi.draw_clip_text=this.drawClipText;windowAny.DApi.draw_text=this.drawText;windowAny.DApi.draw_belt=this.drawBelt}}class Sound{constructor(){this.initSound=()=>{const n=window.AudioContext||windowAny.webkitAudioContext;if(n){this.context=null;try{this.context=new n}catch(t){}this.sounds=new Map}};this.createSound=(n,t)=>{if(this.context){const i=this.decodeAudioData(this.context,t.buffer);this.sounds.set(n,{buffer:i,gain:this.context.createGain(),panner:StereoPannerNode&&new StereoPannerNode(this.context,{pan:0})})}};this.createSoundRaw=(n,t,i,r,u)=>{if(this.context){const f=this.context.createBuffer(r,i,u);for(let n=0;n<r;++n)f.getChannelData(n).set(t.subarray(n*i,n*i+i));this.sounds.set(n,{buffer:Promise.resolve(f),gain:this.context.createGain(),panner:StereoPannerNode&&new StereoPannerNode(this.context,{pan:0})})}};this.duplicateSound=(n,t)=>{if(this.context){const i=this.sounds.get(t);i&&this.sounds.set(n,{buffer:i.buffer,gain:this.context.createGain(),panner:StereoPannerNode&&new StereoPannerNode(this.context,{pan:0})})}};this.playSound=(n,t,i,r)=>{const u=this.sounds.get(n);if(u){u.source&&u.source.then(n=>n.stop());u.gain.gain.value=Math.pow(2,t/1e3);const n=Math.pow(2,i/1e3);u.panner&&(u.panner.pan.value=1-2/(1+n));u.source=u.buffer.then(n=>{const t=this.context.createBufferSource();t.buffer=n;t.loop=!!r;let i=t.connect(u.gain);return u.panner&&(i=i.connect(u.panner)),i.connect(this.context.destination),t.start(),t})}};this.stopSound=n=>{const t=this.sounds.get(n);t&&t.source&&(t.source.then(n=>n.stop()),delete t.source)};this.deleteSound=n=>{const t=this.sounds.get(n);t&&t.source&&t.source.then(n=>n.stop());this.sounds.delete(n)};this.setVolume=(n,t)=>{const i=this.sounds.get(n);i&&(i.gain.gain.value=Math.pow(2,t/1e3))};this.decodeAudioData=(n,t)=>new Promise((i,r)=>{n.decodeAudioData(t,i,r)});windowAny.DApi.create_sound=this.createSound;windowAny.DApi.create_sound_raw=this.createSoundRaw;windowAny.DApi.play_sound=this.playSound;windowAny.DApi.stop_sound=this.stopSound;windowAny.DApi.delete_sound=this.deleteSound;windowAny.DApi.duplicate_sound=this.duplicateSound;windowAny.DApi.set_volume=this.setVolume}}class Progress{constructor(n,t,i){this.message=n;this.bytesLoaded=t;this.total=i}}class FileStore{constructor(){this.initIndexedDb=async()=>{this.store=new IdbKvStore("diablo_fs");for(let[n,t]of Object.entries(await this.store.json()))this.files.set(n.toLowerCase(),t)};this.updateIndexedDbFromUint8Array=async(n,t)=>{await this.store.set(n,t)};this.readIndexedDb=async n=>await this.store.get(n.toLowerCase());this.indexedDbHasFile=async n=>{const t=await this.store.get(n.toLowerCase());return t?!0:!1};this.storeSpawnUnmarshalledBegin=async(n,t)=>{const u=windowAny.Module.HEAPU8.subarray(n,n+t),i=new Uint8Array(u),r="spawn.mpq";await this.store.set(r,i);this.files.set(r,i);getInterop().dotNetReference.invokeMethodAsync("StoreSpawnUnmarshalledEnd")};this.readFile=n=>new Promise((t,i)=>{const r=new FileReader;r.onload=()=>t(r.result);r.onerror=()=>i(r.error);r.onabort=()=>i();r.onprogress=n=>getInterop().dotNetReference.invokeMethodAsync("OnProgress",new Progress("Loading...",n.loaded,n.total));r.readAsArrayBuffer(n)});this.getFileFromInput=async n=>{const i=document.getElementById(n),t=i.files[0],r=t.name.toLowerCase(),u=new Uint8Array(await this.readFile(t));return{name:r,data:u}};this.onDropFile=n=>{this.dropFile=this.getDropFile(n),this.dropFile&&(n.preventDefault(),getInterop().dotNetReference.invokeMethodAsync("Start",this.dropFile.name.toLowerCase(),!0))};this.getDropFile=n=>{const t=n.dataTransfer.items;if(t)for(let n=0;n<t.length;++n)if(t[n].kind==="file")return t[n].getAsFile();const i=n.dataTransfer.files;if(i.length)return i[0]};this.setDropFile=async()=>{const n=new Uint8Array(await this.readFile(this.dropFile));this.files.set(this.dropFile.name.toLowerCase(),n);this.dropFile=null};this.setInputFile=async()=>{const n=await this.getFileFromInput("mpqInput");this.files.set(n.name,n.data)};this.uploadFile=async()=>{const n=await this.getFileFromInput("saveInput");this.files.set(n.name,n.data);this.store.set(n.name,n.data)};this.hasFile=(n,t)=>{const i=this.files.get(n.toLowerCase());return i?t.length>0?t.includes(i.byteLength):!0:!1};this.getFilenames=()=>[...this.files.keys()];this.getFilesize=n=>{const t=this.files.get(n.toLowerCase());return t?t.byteLength:0};this.getFileContents=(n,t,i)=>{const r=this.files.get(n.toLowerCase());r&&t.set(r.subarray(i,i+t.byteLength))};this.putFileContents=async(n,t)=>{n=n.toLowerCase(),this.files.set(n,t),await this.updateIndexedDbFromUint8Array(n,t)};this.removeFile=async n=>{n=n.toLowerCase(),this.files.delete(n),await this.store.remove(n)};this.getRenderInterval=()=>{const n=localStorage.getItem("DiabloRenderInterval");return n?parseInt(n):50};this.setRenderInterval=n=>{localStorage.setItem("DiabloRenderInterval",n.toString())};this.files=new Map;windowAny.DApi.get_file_size=this.getFilesize;windowAny.DApi.get_file_contents=this.getFileContents;windowAny.DApi.put_file_contents=this.putFileContents;windowAny.DApi.remove_file=this.removeFile}}class Interop{constructor(){this.setDotNetReference=n=>{this._dotNetReference=n};this.addEventListeners=()=>{window.addEventListener("resize",()=>this._dotNetReference.invokeMethodAsync("OnResize",this.getCanvasRect()));const n=document.getElementById("main");n.addEventListener("drop",n=>this._fileStore.onDropFile(n))};this.getCanvasRect=()=>this.canvas.getBoundingClientRect();this.openKeyboard=()=>{};this.closeKeyboard=()=>{};this.exitError=n=>{throw Error(n);};this.exitGame=()=>{this._dotNetReference.invokeMethodAsync("OnExit")};this.currentSaveId=n=>{this._dotNetReference.invokeMethodAsync("SetSaveName",n)};this.setCursor=(n,t)=>{this._dotNetReference.invokeMethodAsync("SetCursorPos",n,t)};this.reload=()=>{window.location.reload()};this.clickDownloadLink=(n,t,i)=>{n.setAttribute("download",t),n.setAttribute("href",i),n.click(),n.removeAttribute("download"),n.removeAttribute("href")};this._graphics=new Graphics;this._sound=new Sound;this._fileStore=new FileStore;windowAny.DApi.open_keyboard=this.openKeyboard;windowAny.DApi.close_keyboard=this.closeKeyboard;windowAny.DApi.set_cursor=this.setCursor;windowAny.DApi.current_save_id=this.currentSaveId;windowAny.DApi.exit_game=this.exitGame;windowAny.DApi.exit_error=this.exitError}get graphics(){return this._graphics}get sound(){return this._sound}get fileStore(){return this._fileStore}get canvas(){return this._canvas||(this._canvas=document.getElementById("canvas")),this._canvas}get dotNetReference(){return this._dotNetReference}}const windowAny=window;windowAny.DApi={};windowAny.interop=new Interop;const getInterop=()=>windowAny.interop;